<!DOCTYPE html>
<html>
	<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docs jQuery Mobile - L'Ajax, les hashes &amp; l'historique</title>
	<link rel="stylesheet"  href="../../css/themes/default/" />
	<link rel="stylesheet" href="../_assets/css/jqm-docs.css"/>
	<script src="../../js/jquery.js"></script>
	<script src="../../experiments/themeswitcher/jquery.mobile.themeswitcher.js"></script>
	<script src="../_assets/js/jqm-docs.js"></script>
	<script src="../../js/"></script>
</head>
<body>

	<div data-role="page" class="type-interior">

		<div data-role="header" data-theme="f">
		<h1>Ajax, hashes &amp; historique</h1>
		<a href="../../" data-icon="home" data-iconpos="notext" data-direction="reverse" class="ui-btn-right jqm-home">Accueil</a>
	</div><!-- /header -->

	<div data-role="content">
		<div class="content-primary">
			<h2>Modèle de navigation de jQuery Mobile</h2>

			<p>Une "page" dans jQuery Mobile est composée d'un élément (généralement un <code>div </code>) avec un attribut <code> data-role</code> défini à <code>"page"</code>, qui contient généralement des éléments <code> div</code> avec des rôles <code>"header"</code>, <code>"content"</code> et <code>"footer"</code>, chacun contenant le balisage commun, les formulaires et les widgets personnalisés de jQuery Mobile.</p>

			<p>L'automatisation des processus de base pour un chargement d'une page est la suivante : d'abord, une page est appelée par une requête HTTP normale, et les "pages" suivantes sont alors appelées et injectées dans le DOM de cette page. Pour cette raison, le DOM peut avoir un certain nombre de «pages» en même temps, dont chacune peut être revisitée en liant son attribut <code>data-url</code>.</p>

			<p>Quand une URL est initialement appelée, il peut y avoir un ou plusieurs "pages" dans la réponse et seule la première sera affichée. L'avantage de stocker plus d'une "page" est de permettre de pré-télécharger les pages statiques qui sont susceptibles d'être visitées.</p>

			<h2>Navigation des pages pilotée par hash et Ajax</h2>

			<p>Par défaut, toute la navigation dans jQuery Mobile est basée sur les changements et les mises à jour de <code>location.hash</code>. Autant que possible, les changements de page utiliseront une transition en douceur entre la "page" courante et la suivante, si elle est soit déjà présente dans les DOM ou soit automatiquement chargée via Ajax.</p>

			<p>Les valeurs de hash créée par jQuery Mobile sont normalisées comme des chemins complets par rapport à l'URL de la première "vraie" page qui a été chargée. Le hash est toujours maintenue comme une URL valide, de sorte que toute «page» dans jQuery mobile puisse être marquée ou référencée dans un lien. Pour récupérer une URL non basée sur le hash, il suffit de retirer le # à partir de l'adresse et actualiser la page.</p>

			<p>En général, les changements de hash sont créés chaque fois qu'un lien est cliqué dans jQuery Mobile. Quand un lien est cliqué, jQuery mobile s'assurera que le lien fait référence à une URL locale, et si c'est le cas, il va prévenir le comportement par défaut du clic du lien de se produire et demander l'URL référencées via Ajax à la place. Lorsque la page retourne avec succès, cela définira le location.hash avec l'url relative de la nouvelle page. </p>

			<p>Lorsque la page retourne avec succès, cela définira à le location.hash avec l'url relative de la nouvelle page . Quand un changement de hash survient (et aussi quand la page se charge en premier), le gestionnaire d'événements hashchange enverra le location.hash à la fonction <code>$.mobile.changePage()</code> qui à son tour, soit charge ou soit révèle la page référencée.</p>


			<p>Une fois que la page référencée est présente dans le DOM, la fonction <code>$.mobile.changePage()</code> applique une transition entre la page active actuelle et la nouvelle page. Les transitions de page se produisent grâce à l'ajout et la suppression des classes qui s'appliquent aux animations CSS. Par exemple, dans une transition slide-left, la page existante est donnée aux classes "slideleft" et "out", et la page entrante est donnée aux classes  <code>"slideleft"</code> and <code>"in"</code>, ainsi qu'à une classe <code>"ui-page-active"</code> pour la marquer comme la nouvelle page "active" à la visualisation. Lorsque l'animation est terminée, les classes  <code>"in"</code> et <code>"out"</code> sont supprimées, et la page quittée perd sa classe <code>"ui-page-active"</code>.</p>

			<h2>Plugin pushState</h2>

			<p>There is an optional feature is converts the longer, hash-based URLs mentioned in the previous section into the full document path which is cleaner and makes the Ajax tracking transparent in the URL structure. This is built as an enhancement on top of the hash-based URL system for Ajax links. Note that despite the name, this feature technically converts hash-based urls by using <code>history.replaceState</code> (not <code>history.pushState</code>) in the current release because this works more reliably across our target platforms. For browsers that do not support <code>history.replaceState</code>, or if this feature is disabled, hash-based URLs will be used instead.  </p>

			<p>Since the plugin initializes when the DOM is fully loaded you can enable and disable it manually by setting <code>$.mobile.pushStateEnabled</code> global <a href="../api/globalconfig.html">configuration option</a> to <code>false</code> anytime before document ready.</p>

			<div class="ui-body ui-body-e">
				<h4 style="margin:.5em 0">Important: rel="external" and $.mobile.ajaxEnabled=false</h4>
        <p>Slightly different implementations of the replaceState API in various browsers can cause odd behavior in specific scenarios. For example, some browser implementations (including desktop browsers) implement the <code>popstate</code> event differently when linking externally and moving back to a page onto which state has already been pushed/replaced. When building a jQuery Mobile application where the ajax navigation is being explicitly disabled, either though the frequent use of <code>rel="external"</code> on links or by disabling Ajax navigation completely via the <code>$.mobile.ajaxEnabled=false</code>, we recommend disabling the pushState feature to fall back to the hash based navigation for more consistent behavior.</p>
			</div>

			<h2>changePage</h2>

			<p>Within the framework, page changes - both for pages already in the DOM and for pages that need to be loaded via Ajax - use the <code>$.mobile.changePage()</code> function. <code>$.mobile.changePage()</code> contains all of the logic for finding pages to transition to and from, and how to handle various response conditions such as a page not found. <code>$.mobile.changePage()</code> can be called externally and accepts the following arguments (to, transition, back, changeHash). The <code>to</code> argument can accept either a string (such as a file url or local element's ID), an array (in which the first array item is any local page you'd like to transition from, and the second array item is the <code>to</code> page), or an object (with expected properties: url, type ("get" or "post"), and data (for serialized parameters)), the latter of which is useful for loading pages that expect form data. The <code>transition</code> argument accepts a string representing a named transition, such as "slide". The <code>back</code> argument accepts a boolean representing whether the transition should go forward or in reverse. Lastly, the <code>changeHash</code> argument accepts a boolean for whether you'd like the url to be updated upon a successful page change.</p>

			<p>The <code>$.mobile.changePage()</code> function is used in a number of places in jQuery Mobile. For example, when a link is clicked, its href attribute is normalized and then <code>$.mobile.changePage()</code> handles the rest. When forms are submitted, jQuery Mobile simply gathers a few of the form's attributes, serializes its data, and once again, <code>$.mobile.changePage()</code> is used to handle the submission and response. Also, links that create dialogs use <code>$.mobile.changePage()</code>to open a referenced page without updating the hash, which is useful for keeping dialogs out of history tracking.  </p>

			<h2>Base element</h2>

			<p>Another key ingredient to jQuery Mobile's page navigation model is the <code>base</code> element, which is injected into the <code>head</code> and modified on every page change to ensure that any assets (images, CSS, JS, etc.) referenced on that page will be requested from a proper path. In browsers that don't support dynamic updates to the <code>base</code> element (such as Firefox 3.6), jQuery Mobile loops through all of the referenced assets on the page and prefixes their href and src attributes with the base path.</p>


			<h2>Developer explanation of base url management:</h2>

			<p>jQuery Mobile manages http requests using a combination of generated absolute URL paths and manipulating a generated <code>&lt;base&gt;</code> element's href attribute. The combination of these two approaches allows us to create URLs that contain full path information for loading pages, and a base element to properly direct asset requests made by those loaded pages (such as images and stylesheets).</p>

<p><strong>TODO: update description of internal base and urlHistory objects</strong></p>

			<h2>Data-url storage</h2>

			<p>The nav model maintains a data-url attribute on all data-role="page" elements. This data-url attribute is used to track the origin of the page element. Pages embedded within the main application document all have their data-url parameter set to the ID of the @data-role="page" element. The only exception to this is the first-page in the document. The first-page is special because it can be addressed by its @id if it has one, or by the document or base URL (with no hash fragment).</p>

			<p>Pages that are external to the application document get pulled in dynamically via ajax, their data-url is set to the site relative path to the external page. If you are running in an environment where loading an external page from a different domain is allowed, then the data-url is set to the absolute URL.</p>

			<h2>Auto-generated pages and sub-hash urls</h2>

			<p>Some plugins may choose to dynamically break a page's content into separate navigable pages, which can then be reached via deep links. One example of this would be the Listview plugin, which will break a nested UL (or OL) into separate pages, which are each given a data-url attribute so they can be linked to like any normal "page" in jQuery Mobile. However, in order to link to these pages, the page that generates them must first be requested from the server. To make this work, pages that are auto-generated by plugins use the following special data-url structure:
			<code>&lt;div data-url="page.html&amp;subpageidentifier"&gt;</code></p>

			<p>So, for example, a page generated by the listview plugin may have an data-url attribute like this: <code>data-url="artists.html&amp;ui-page=listview-1"</code></p>

			<p>When a page is requested, jQuery Mobile knows to split the URL at "&amp;ui-page" and make an HTTP request to the portion of the URL before that key. In the case of the listview example mentioned above, the URL would look like this: http://example.com/artists.html&amp;ui-page=listview-1
			...and jQuery Mobile would request artists.html, which would then generate its sub-pages, creating the div with data-url="artists.html&amp;ui-page=listview-1", which it will then display as the active page.</p>

			<p><em>Note that the data-url attribute of the element contains the full URL path, not just the portion after &amp;ui-page=. This allows jQuery Mobile to use a single consistent mechanism that matches URLs to page data-url attributes.</em></p>

			<h2>Cases when Ajax navigation will not be used</h2>

			<p>Under certain conditions, normal http requests will be used instead of Ajax requests. One case where this is true is when linking to pages on external websites. You can also specify that a normal http request be made through the following link attributes:</p>

			<ul>
			<li><p>rel=external</p></li>
			<li><p>target (with any value, such as "_blank")</p></li>

			</ul><h2>Form submissions</h2>

			<p>Form submissions are handled automatically through the navigation model as well. Visit the forms section for more information.</p>

			<h2>Using the Application Cache</h2>

			<p>When using the application cache with jQuery Mobile there is at least one important issue to consider. Some browsers, when making requests to the cache will report an http status of 0 on success. This causes jQuery Core's <code>$.ajax</code> to trigger error handlers. The suggested workaround for users leveraging the application cache is to use a jQuery ajax pre-filter. Something like the following (credit to <a href="https://github.com/jquery/jquery-mobile/issues/1579#issuecomment-1209338" rel="external">jammus</a> for the snippet):</p>

			<pre><code>

$.ajaxPrefilter( function(options, originalOptions, jqXHR) {
	if ( applicationCache &amp;&amp;
		 applicationCache.status != applicationCache.UNCACHED &amp;&amp;
		 applicationCache.status != applicationCache.OBSOLETE ) {
		 // the important bit
		 options.isLocal = true;
	}
});

			</code></pre>

			<p>Setting <code>isLocal</code> to true for your ajax requests will alert jQuery Core that it should handle the 0 return values differently. Local requests exhibit similar behavior (ie 0 statuses), and Core will then fall back to determining success based on the presence of content in the xhr <code>responseText</code> attribute.</p>

			<p>One important issue to note with the above is that it will set <code>isLocal</code> to true for all requests made via ajax regardless of whether they are in the manifest or not so long as the cache is valid. This works for now because Core only consults the <code>isLocal</code> value when the status is in fact 0 which doesn't affect uncached results. There is no long term guarantee that <code>isLocal</code> will remain isolated in its purpose for handling 0 status values. If that changes it may break your application.</p>

			<h2>Known limitations</h2>

			<p>The non-standard environment created by jQuery Mobile's page navigation model introduces some conditions for which you should be aware when building pages:</p>

			<ul>
			<li><p>When linking to directories, without a filename url, (such as href="typesofcats/" instead of href="typesofcats/index.html"), you must provide a trailing slash. C'est parce que jQuery Mobile suppose que la section après le dernier caractère "/" dans une URL est un nom de fichier, et il va supprimer cette section lors de la création des urls de base à partir duquel les futures pages seront référencées.</p></li>
			<li><p>Documents loaded via Ajax will select the first page in the DOM of that document to be loaded as a JQM page element. As a result the developer must make sure to manage the ID attributes of the loaded page and child elements to prevent confusion when manipulating the DOM.</p></li>
			<li><p>Any unique assets referenced by pages in a jQuery Mobile-driven site should be placed inside the "page" element (the element with a data-role attribute of "page"). For example, links to styles and scripts that are specific to a particular page can be referenced inside that div. However, a better approach is to use jQuery Mobile's page events to trigger specific scripting when certain pages load. <strong>Note: </strong> you can return a page from the server with a data-url already specified in the markup, and jQuery Mobile will use that for the hash update. This allows you to ensure directory paths resolve with a trailing slash and will therefore be used in the base url path for future requests.</p></li>
			<li><p>Conversely, any non-unique assets (those used site-wide) should be referenced in the <code>&lt;head&gt;</code> section of an HTML document, or at the very least, outside of the "page" element, to prevent running scripts more than once.</p></li>
			<li><p>The "ui-page" key name used in sub-hash url references can be set to any value you'd like, so as to blend into your URL structure. This value is stored in <code>jQuery.mobile.subPageUrlKey</code>.</p></li>
			<li><p>When traveling back to a previously loaded jQuery Mobile document from an external <b>or</b> internal document with the push state plugin enabled, some browsers load and trigger the popstate event on the wrong document or for the wrong reasons (two edge cases recorded so far). If you are regularly linking to external documents and find the application behaving erratically try disabling pushstate support.</p></li>
			<li><p>jQuery Mobile does not support query parameter passing to internal/embedded pages but there are two plugins that you can add to your project to support this feature. There is a lightweight <a href="https://github.com/jblas/jquery-mobile-plugins/tree/master/page-params" rel="external">page params plugin</a> and a more fully featured <a href="https://github.com/azicchetti/jquerymobile-router" rel="external">jQuery Mobile router plugin</a> for use with backbone.js or spine.js.</p></li>
			<li><p>Since we use the URL hash to preserve Back button behavior, using page anchors to jump down to a position on the page isn't supported by using the traditional anchor link (#foo). Use the <a href="../api/methods.html"><code>silentScroll</code></a> method to scroll to a particular Y position without triggering scroll event listeners. You can pass in a <code>yPos</code> arguments to scroll to that Y location.</p></li>
			</ul>


				</div><!--/content-primary -->

				<div class="content-secondary">

					<div data-role="collapsible" data-collapsed="true" data-theme="b" data-content-theme="d">

							<h3>Aussi dans cette rubrique</h3>

							<ul data-role="listview" data-theme="c" data-dividertheme="d">

								<li data-role="list-divider">Pages &amp; Boîtes de dialogue</li>
								<li><a href="page-anatomy.html">Anatomie d'une page</a></li>
								<li><a href="page-template.html" data-ajax="false">Modèle de page unique</a></li>
								<li><a href="multipage-template.html" data-ajax="false">Modèle Multi-page</a></li>
								<li><a href="page-titles.html">Titres de page</a></li>
								<li><a href="page-links.html">Liaison de pages</a></li>
								<li><a href="page-transitions.html" data-ajax="false">Transitions de page</a></li>
								<li><a href="page-dialogs.html">Boîtes de dialogue</a></li>
								<li><a href="page-cache.html">Le préchargement &amp; la mise en cache des pages</a></li>
								<li data-theme="a"><a href="page-navmodel.html">Ajax, hashes &amp; historique</a></li>
								<li><a href="page-dynamic.html">Injection dynamique des pages</a></li>
								<li><a href="page-scripting.html">Écriture des scripts des pages</a></li>
								<li><a href="pages-themes.html">Thématisation des pages</a></li>

							</ul>
					</div>
				</div>

			</div><!-- /content -->

			<div data-role="footer" class="footer-docs" data-theme="c">
					<p>© 2011 The jQuery Project</p>
			</div>

			</div><!-- /page -->

			</body>
			</html>
